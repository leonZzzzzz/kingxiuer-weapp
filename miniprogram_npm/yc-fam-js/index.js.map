{"version":3,"sources":["index.js","lib\\fam-sdk.js","lib\\storage.js","lib\\environment.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;;ACDA;AACA;AACA;AACA,ACHA;ADIA,ACHA;ADIA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ACFA,AFMA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA,ACHA;ADIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["module.exports = require('./lib/fam-sdk')\n","\nvar __TEMP__ = require('./storage');var Storage = __REQUIRE_DEFAULT__(__TEMP__);\nvar __TEMP__ = require('./environment');var envString = __REQUIRE_DEFAULT__(__TEMP__);\nconst sha1 = require('js-sha1')\nconst axios = require('axios')\nconst md5 = require('md5')\n\nif (!exports.__esModule) Object.defineProperty(exports, \"__esModule\", { value: true });exports.default = class YCFam {\n  /**\n   *\n   * @param {String} appId 应用 Id，由 yuncheng 分配\n   * @param {String} appSecret 应用密钥，由 yuncheng 分配\n   * @param {String} unionId 用户唯一标识符。同一个应用內，两个用户不能重复\n   */\n  constructor(appId, appSecret, unionId) {\n    this.appId = appId\n    this.appSecret = appSecret\n    this.unionId = unionId\n    this.storage = new Storage()\n    this.baseURL = 'https://saas.shecarefertility.com'\n    this.envString = envString()\n  }\n\n  getCTS() {\n    return ((new Date().getTime() / 1000) | 0) + ''\n  }\n\n  /**\n   * 返回算法签名，用于接口校验\n   * @param {String} cTS 时间戳，单位秒\n   * @returns {String} SHA1 加密字符串\n   */\n  getSigns(cTS) {\n    if (!cTS || cTS.length === 0) {\n      cTS = this.getCTS()\n    }\n    return sha1(this.appId + this.appSecret + cTS + 'yunchengSaas')\n  }\n\n  commonGetParams(sessionId) {\n    let dataURL = '?'\n    dataURL += 'appId=' + this.appId\n    let cTS = this.getCTS()\n    dataURL += '&signs=' + this.getSigns(cTS)\n    dataURL += '&ts=' + cTS\n    dataURL += '&sessionId=' + sessionId\n    dataURL += '&version=v2'\n    return dataURL\n  }\n\n  /**\n   * 发起算法请求\n   * @param {String} debugId 格式为 UUID 的字符串，用于唯一标记一次请求\n   * @param {Object} input 算法的输入项\n   * @returns {Promise} 返回算法请求结果\n   */\n  getFAMDays(debugId, input) {\n    let newKey = md5(JSON.stringify(input))\n    let oldResult = this.storage.getItem(newKey)\n    if (oldResult) {\n      return new Promise((resolve) => {\n        resolve(JSON.parse(oldResult))\n      })\n    }\n    let data = Object.assign(\n      {\n        appId: this.appId,\n        unionId: this.unionId,\n        debugId: debugId\n      },\n      { data: input }\n    )\n    let url = this.baseURL + '/custom/al/yuncheng/famGetDay' + this.commonGetParams(debugId)\n    if (this.envString === 'mnp') {\n      return this.getFAMDaysForMNP(newKey, url, data)\n    } else {\n      return this.getFAMDaysForH5(newKey, url, data)\n    }\n  }\n\n  getFAMDaysForMNP(newKey, url, data) {\n    const self = this\n    return new Promise((resolve, reject) => {\n      wx.request({\n        method: 'post',\n        url: url,\n        data: data,\n        success(res) {\n          if (res.data.code === 200) {\n            // Local storage can only save strings\n            self.storage.setItem(newKey, JSON.stringify(res.data))\n            resolve(res.data)\n          } else {\n            reject(new Error(res.data.message))\n          }\n        },\n        fail(err) {\n          reject(err)\n        }\n      })\n    })\n  }\n\n  getFAMDaysForH5(newKey, url, data) {\n    const self = this\n    let reqInstance = axios.create()\n    return new Promise((resolve, reject) => {\n      reqInstance({\n        method: 'post',\n        url: url,\n        data: data\n      })\n        .then((res) => {\n          if (res.data.code === 200) {\n            // Local storage can only save strings\n            self.storage.setItem(newKey, JSON.stringify(res.data))\n            resolve(res.data)\n          } else {\n            reject(new Error(res.data.message))\n          }\n        })\n        .catch((err) => {\n          reject(err)\n        })\n    })\n  }\n};\n","var __TEMP__ = require('./environment');var envString = __REQUIRE_DEFAULT__(__TEMP__);\n\nif (!exports.__esModule) Object.defineProperty(exports, \"__esModule\", { value: true });exports.default = class Storage {\n  constructor() {\n    this.envString = envString()\n    this.storage = new Map()\n    this.itemsKey = 'yc_fam_js_cache'\n    this.itemsCount = 3\n  }\n\n  getItems() {\n    let itemsStr = ''\n    if (this.envString === 'mnp') {\n      itemsStr = wx.getStorageSync(this.itemsKey)\n    } else if (this.envString === 'node') {\n      itemsStr = this.storage.get(this.itemsKey)\n    } else {\n      itemsStr = window.localStorage.getItem(this.itemsKey)\n    }\n\n    let items = []\n    if (itemsStr) {\n      items = JSON.parse(itemsStr)\n    }\n    return items\n  }\n\n  getItem(key) {\n    let items = this.getItems()\n    for (let i = 0; i < items.length; i++) {\n      const item = items[i]\n      if (item.intput === key) {\n        return item.output\n      }\n    }\n    return null\n  }\n\n  setItem(key, value) {\n    let items = this.getItems()\n    while (items.length >= this.itemsCount) {\n      items.shift()\n    }\n    let newItem = {\n      intput: key,\n      output: value\n    }\n    items.push(newItem)\n\n    let itemsStr = JSON.stringify(items)\n    if (this.envString === 'mnp') {\n      wx.setStorageSync(this.itemsKey, itemsStr)\n    } else if (this.envString === 'node') {\n      this.storage.set(this.itemsKey, itemsStr)\n    } else {\n      window.localStorage.setItem(this.itemsKey, itemsStr)\n    }\n  }\n};\n","if (!exports.__esModule) Object.defineProperty(exports, \"__esModule\", { value: true });exports.default = function envString() {\n  // This should first return, for `npm test`\n  if (typeof process === 'object') {\n    if (typeof process.versions === 'object') {\n      if (typeof process.versions.node !== 'undefined') {\n        return 'node'\n      }\n    }\n  }\n  try {\n    if (wx.navigateTo) {\n      return 'mnp'\n    }\n  } catch (error) {    \n  }\n  \n  var ua = navigator.userAgent.toLowerCase()\n  if (ua.match(/MicroMessenger/i) == 'micromessenger') {\n    return 'wechat'\n  }\n  return 'brower'\n};"]}